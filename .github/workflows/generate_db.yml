name: Generate Database

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Generate database files
        run: |
          mkdir -p data
          node << 'EOF'
          const fs = require('fs');

          const categories = [
            "zusatzstoffe","zucker","verpackung","verarbeitung","naehrstoffe",
            "konservierer","dufte","polymere","uvfilter","tenside",
            "strahlung","raumluft","reiniger","wasser","textilien",
            "schlaf","medikamente","stimulanzien","lebensstil","immunsystem",
            "abos","versicherungen","kredite","marketing","digitales",
            "kinder","senioren","tiere","umwelt","trends"
          ];

          function random(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

          for (let file = 1; file <= 10; file++) {
            const out = [];

            for (let i = 1; i <= 10000; i++) {
              const globalId = (file - 1) * 10000 + i;
              const id = "entry_" + globalId.toString().padStart(6, "0");
              const cat = random(categories);

              out.push({
                id: id,
                name: "Eintrag " + id,
                category: cat,
                subcategory: "allgemein",
                risk_level: random(["sehr niedrig","niedrig","mittel","hoch","sehr hoch"]),
                processing_warning: "Kann in industriell verarbeiteten Produkten oder modernen Alltagsprodukten vorkommen.",
                ultra_processed_score: Math.floor(Math.random() * 6),
                description: "Automatisch erzeugter Platzhalter-Datensatz für die MarketShield-Datenbank.",
                health_effects: [
                  "Mögliche Belastung bei hoher oder langfristiger Exposition",
                  "Details hängen von Produkt, Dosis und individueller Empfindlichkeit ab"
                ],
                use_cases: [
                  "Typisch für Produkte der Kategorie \"" + cat + "\""
                ],
                alternatives: [
                  {
                    name: "Schonendere Alternative",
                    description: "Mehr unverarbeitete, transparente oder natürlich zusammengesetzte Produkte wählen."
                  }
                ],
                sources: [
                  "Allgemeine Verbraucherinformationen",
                  "Fachliteratur und Überblicksartikel"
                ],
                tags: [cat, "autogenerated"]
              });
            }

            const fileName = `data/db_${String(file).padStart(3, "0")}.json`;
            fs.writeFileSync(fileName, JSON.stringify(out, null, 2), "utf8");
          }
          EOF

      - name: Commit files
        run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add data/db_*.json || true
          git commit -m "Generate database files" || true
          git push || true
