name: Generate Database

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Generate database files
      run: |
        mkdir -p data
        node << 'EOF'
        const fs = require('fs');

        const categories = [
          "zusatzstoffe","zucker","verpackung","verarbeitung","naehrstoffe",
          "konservierer","dufte","polymere","uvfilter","tenside",
          "strahlung","raumluft","reiniger","wasser","textilien",
          "schlaf","medikamente","stimulanzien","lebensstil","immunsystem",
          "abos","versicherungen","kredite","marketing","digitales",
          "kinder","senioren","tiere","umwelt","trends"
        ];

        function random(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

        for (let file = 1; file <= 10; file++) {
          const out = [];
          for (let i = 1; i <= 10000; i++) {
            const id = "entry_" + ((file - 1) * 10000 + i);
            const cat = random(categories);
            out.push({
              id: id,
              name: "Eintrag " + id,
              category: cat,
              risk_level: random(["niedrig","mittel","hoch"]),
              processing_warning: "Kann in industriell verarbeiteten Produkten vorkommen.",
              ultra_processed_score: Math.floor(Math.random() * 6),
              description: "Automatisch erzeugter Datensatz.",
              alternatives: ["Unverarbeitete Produkte bevorzugen"],
              sources: ["Verbraucherschutz"],
              tags: [cat]
            });
          }
          fs.writeFileSync(`data/db_${String(file).padStart(3,"0")}.json`, JSON.stringify(out, null, 2));
        }
        EOF

    - name: Commit files
      run: |
        git config user.email "action@github.com"
        git config user.name "GitHub Action"
        git add data/db_*.json
        git commit -m "Generated database" || true
        git push
